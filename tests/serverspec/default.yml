- hosts: localhost
  pre_tasks:
    # XXX kill dhclient to ensure resolv.conf is never modified by it
    - shell: dhclient -x
      changed_when: false
      ignore_errors: true # so that "kitchen converge && kitchen converge" works
      when:
        - ansible_os_family == 'RedHat' or ansible_os_family == 'Debian'
    - shell: pkill dhclient
      when:
        - ansible_os_family == 'OpenBSD'
      changed_when: false
      ignore_errors: true
    - service:
        name: dhclient
        state: stopped
      changed_when: false
      ignore_errors: true
      when:
        - ansible_os_family == 'FreeBSD'

  roles:
    - ansible-role-resolver
  vars:
    nameservers:
      - 192.168.1.1
      - 192.168.1.2
      - 192.168.1.3
    # XXX ansible_fqdn is generally preferred to ansible_hostname to avoid
    # collision, but ansible_fqdn is generated by socket.getfqdn, which
    # returns different values when DNS servers are not available. as a list
    # of invalid DNS servers are used in the test, socket.getfqdn on OpenBSD
    # returns different value before and after the first play. use
    # ansible_hostname here to pass idempotency_test
    resolver_nameservers: "{{ nameservers | predictable_shuffle(ansible_hostname) | list }}"
